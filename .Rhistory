group_by(nodo) %>%
summarise(grado = sum(grado)) %>%
arrange(desc(grado))
# grado de los nodos en tabla para graficar
grado_nodos <- gen_gcf %>%
# Contar apariciones de cada MAG
count(Mags, name = "grado") %>%
rename(nodo = Mags) %>%
bind_rows(
# Contar apariciones de cada BGC
gen_gcf %>%
count(Bgcs, name = "grado") %>%
rename(nodo = Bgcs)
) %>%
group_by(nodo) %>%
summarise(grado = sum(grado)) %>%
arrange(desc(grado))
View(grado_nodos)
# grado de los nodos en tabla para graficar
grado_mags <- gen_gcf %>%
count(Mags, name = "grado") %>%   # cuenta cuántas veces aparece cada MAG
rename(nodo = Mags) %>%
arrange(desc(grado)) %>%
mutate(tipo = "MAG")
View(grado_mags)
gc()
library(tidyverse)
library(ggplot2)
motu_gcf <- read.csv(file = '~/2025-interacions/motu_gcf/all_cases.csv', header = TRUE)
motu_gcc <- read.csv(file = '~/2025-interacions/motu_gcc/all_cases.csv', header = TRUE)
fam_gcf <- read.csv(file = '~/2025-interacions/fam_gcf/all_cases.csv', header = TRUE)
fam_gcc <- read.csv(file = '~/2025-interacions/fam_gcc/all_cases.csv', header = TRUE)
gen_gcf <- read.csv(file = '~/2025-interacions/gen_gcf/all_cases.csv', header = TRUE)
gen_gcc <- read.csv(file = '~/2025-interacions/gen_gcc/all_cases.csv', header = TRUE)
setwd("~/MAGs_BGCs_interactions")
meta_mags <- read.csv("metadata.csv")
meta_bgcs <- read.csv("bgcs_metadata.csv")
# correcting by FDR and filtering the cases with p-value > 0.05
correct <- function(df) {
df <- df %>%
mutate(
fdr_pval_e = p.adjust(pvalue_e, method = "BH"),
fdr_pval_o = p.adjust(pvalue_o, method = "BH")
)
list(
exclusion = df %>% filter(fdr_pval_e < 0.05),
occurrence = df %>% filter(fdr_pval_o < 0.05)
)
}
motu_gcc <- correct(motu_gcc)
library(igraph)
library(RCy3)
library(paletteer)
cytoscapePing()
cytoscapePing()
oc <- motu_gcc$occurrence
### 1. Colores por grupo representativo ----
rep_bgcs <- meta_bgcs %>%
group_by(gcc, products) %>%
summarise(n = n(), .groups = "drop_last") %>%
slice_max(order_by = n, n = 1) %>%
select(gcc, rep_bgc = products) %>%
rename(id = gcc)
rep_mags <- meta_mags %>%
group_by(mOTUs_Species_Cluster, family) %>%
summarise(n = n(), .groups = "drop_last") %>%
slice_max(order_by = n, n = 1) %>%
select(mOTUs_Species_Cluster, rep_mag = family) %>%
rename(id = mOTUs_Species_Cluster)
### 2. Crear nodos y aristas ----
nodes <- data.frame(
id = unique(c(oc$Mags, oc$Bgcs)),
type = c(rep("MAG", length(unique(oc$Mags))),
rep("BGC", length(unique(oc$Bgcs))))
)
edges <- oc %>%
rename(source = Mags, target = Bgcs, weight = fdr_pval_o)
### 3. Crear grafo y calcular grados ----
g <- graph_from_data_frame(d = edges, vertices = nodes, directed = FALSE)
nodes$degree <- degree(g)
### 4. Añadir metadatos ----
nodes <- nodes %>%
left_join(rep_mags, by = "id") %>%
left_join(rep_bgcs, by = "id") %>%
mutate(color_group = if_else(type == "MAG", rep_mag, rep_bgc))
### 5. Seleccionar top grupos por grado medio ----
top_mag_nodes <- nodes %>%
filter(type == "MAG") %>%
arrange(desc(degree)) %>%
slice_head(n = 12)
top_mag_groups <- unique(top_mag_nodes$color_group)
top_bgc_nodes <- nodes %>%
filter(type == "BGC") %>%
arrange(desc(degree)) %>%
slice_head(n = 13)
top_bgc_groups <- unique(top_bgc_nodes$color_group)
### 6. Crear red en Cytoscape ----
createNetworkFromDataFrames(
nodes = nodes,
edges = edges,
title = "mOTUs-GCCs",
collection = "Interacciones MAGs-BGCs"
)
### 7. Asignar forma de nodos ----
setNodeShapeMapping("type", c("MAG", "BGC"), c("ELLIPSE", "DIAMOND"))
### 8. Paletas de colores ----
mag_colors <- substr(
as.vector(paletteer::paletteer_d(
palette = "ggthemes::calc",
n = length(top_mag_groups)
)),
1, 7
)
bgc_colors <- substr(
as.vector(paletteer::paletteer_d(
palette = "ggthemes::gdoc",
n = length(top_bgc_groups)
)),
1, 7
)
### 9. Asignar color a nodos ----
nodes <- nodes %>%
mutate(color = case_when(
type == "MAG" & color_group %in% top_mag_groups ~
mag_colors[match(color_group, top_mag_groups)],
type == "BGC" & color_group %in% top_bgc_groups ~
bgc_colors[match(color_group, top_bgc_groups)],
TRUE ~ "darkgrey"
))
### 10. Aplicar colores en Cytoscape ----
setNodeColorBypass(
node.names = nodes$id,
new.colors = nodes$color
)
oc <- motu_gcc$exclusion
nodes <- data.frame(
id = unique(c(oc$Mags, oc$Bgcs)),
type = c(rep("MAG", length(unique(oc$Mags))),
rep("BGC", length(unique(oc$Bgcs))))
)
edges <- oc %>%
rename(source = Mags, target = Bgcs, weight = fdr_pval_e)
### 3. Crear grafo y calcular grados ----
g <- graph_from_data_frame(d = edges, vertices = nodes, directed = FALSE)
nodes$degree <- degree(g)
### 4. Añadir metadatos ----
nodes <- nodes %>%
left_join(rep_mags, by = "id") %>%
left_join(rep_bgcs, by = "id") %>%
mutate(color_group = if_else(type == "MAG", rep_mag, rep_bgc))
mag_colors <- substr(
as.vector(paletteer::paletteer_d(
palette = "ggthemes::excel_Gallery",
n = length(top_mag_groups)
)),
1, 7
)
top_mag_nodes <- nodes %>%
filter(type == "MAG") %>%
arrange(desc(degree)) %>%
slice_head(n = 2)
top_bgc_nodes <- nodes %>%
filter(type == "BGC") %>%
arrange(desc(degree)) %>%
slice_head(n = 10)
top_mag_groups <- unique(top_mag_nodes$color_group)
top_bgc_groups <- unique(top_bgc_nodes$color_group)
mag_colors <- substr(
as.vector(paletteer::paletteer_d(
palette = "ggthemes::excel_Gallery",
n = length(top_mag_groups)
)),
1, 7
)
bgc_colors <- substr(
as.vector(paletteer::paletteer_d(
palette = "ggthemes::stata_s1rcolor",
n = length(top_bgc_groups)
)),
1, 7
)
### 9. Asignar color a nodos ----
nodes <- nodes %>%
mutate(color = case_when(
type == "MAG" & color_group %in% top_mag_groups ~
mag_colors[match(color_group, top_mag_groups)],
type == "BGC" & color_group %in% top_bgc_groups ~
bgc_colors[match(color_group, top_bgc_groups)],
TRUE ~ "darkgrey"
))
# Visualizar leyenda
legend_df <- tibble(
Tipo = c(rep("MAG", length(top_mag_groups)),
rep("BGC", length(top_bgc_groups))),
Grupo = c(top_mag_groups, top_bgc_groups),
Color = c(mag_colors, bgc_colors)
)
View(legend_df)
createNetworkFromDataFrames(
nodes = nodes,
edges = edges,
title = "mOTUs-GCCs",
collection = "Interacciones MAGs-BGCs"
)
### 10. Aplicar colores en Cytoscape ----
setNodeColorBypass(
node.names = nodes$id,
new.colors = nodes$color
)
top_mag_nodes <- nodes %>%
filter(type == "MAG") %>%
arrange(desc(degree)) %>%
slice_head(n = 2)
top_bgc_nodes <- nodes %>%
filter(type == "BGC") %>%
arrange(desc(degree)) %>%
slice_head(n = 12)
top_mag_groups <- unique(top_mag_nodes$color_group)
top_bgc_groups <- unique(top_bgc_nodes$color_group)
mag_colors <- substr(
as.vector(paletteer::paletteer_d(
palette = "ggthemes::excel_Gallery",
n = length(top_mag_groups)
)),
1, 7
)
bgc_colors <- substr(
as.vector(paletteer::paletteer_d(
palette = "ggthemes::stata_s1rcolor",
n = length(top_bgc_groups)
)),
1, 7
)
### 9. Asignar color a nodos ----
nodes <- nodes %>%
mutate(color = case_when(
type == "MAG" & color_group %in% top_mag_groups ~
mag_colors[match(color_group, top_mag_groups)],
type == "BGC" & color_group %in% top_bgc_groups ~
bgc_colors[match(color_group, top_bgc_groups)],
TRUE ~ "darkgrey"
))
### 10. Aplicar colores en Cytoscape ----
setNodeColorBypass(
node.names = nodes$id,
new.colors = nodes$color
)
# Visualizar leyenda
legend_df <- tibble(
Tipo = c(rep("MAG", length(top_mag_groups)),
rep("BGC", length(top_bgc_groups))),
Grupo = c(top_mag_groups, top_bgc_groups),
Color = c(mag_colors, bgc_colors)
)
ggplot(legend_df, aes(x = Tipo, y = Grupo, fill = Color)) +
geom_tile(color = "white") +
scale_fill_identity() +
theme_minimal() +
theme(
axis.text.x = element_text(angle = 45, hjust = 1),
axis.text.y = element_text(size = 8)
) +
labs(title = "Guía de colores para MAGs y BGCs",
x = "Tipo de nodo",
y = "Grupo representativo")
library(terra)
library(rnaturalearth)
library(rnaturalearthdata)
motu_gcc <- read.csv(file = '~/2025-interacions/motu_gcc/all_cases.csv', header = TRUE)
# correcting by FDR and filtering the cases with p-value > 0.05
correct <- function(df) {
df <- df %>%
mutate(
fdr_pval_e = p.adjust(pvalue_e, method = "BH"),
fdr_pval_o = p.adjust(pvalue_o, method = "BH")
)
list(
exclusion = df %>% filter(fdr_pval_e < 0.05),
occurrence = df %>% filter(fdr_pval_o < 0.05)
)
}
motu_gcc <- correct(motu_gcc)
meta_mags <- read.csv("metadata.csv")
ex <- motu_gcc$exclusion
View(ex)
prep_mags <- function(meta_mags, mags){
mags <- sym(mags)
# data prep
num_meta <- nrow(meta_mags)
meta_mags <- meta_mags %>% filter(!is.na(!!mags)) # omit NAs
fil_meta <- num_meta - nrow(meta_mags)
message("\n NOTE:", fil_meta, " MAGs were discarded due to missing ", mag_lineage," classification")
# Count the number of MAGs per site and phylogenetic groups
mags_by_sites <- meta_mags %>%
count(station, !!mags) %>%
pivot_wider(names_from = !!mags, values_from = n, values_fill = 0)
return(mags_by_sites)
}
prep_bgcs <- function(meta_bgcs, bgcs){
bgcs <- sym(bgcs)
# count the number of BGCs per site and GCF
bgcs_by_sites <- meta_bgcs %>%
count(station, !!bgcs) %>%
pivot_wider(names_from = !!bgcs, values_from = n, values_fill = 0)
return(bgcs_by_sites)
}
recreate_table <- function(mag, bgc, m_by_sites, b_by_sites) {
# select the station column and the current column for both tables
table1 <- m_by_sites[, c("station", mag), drop = FALSE]
table2 <- b_by_sites[, c("station", bgc), drop = FALSE]
# bind col1 and col2 by station (full_join porque sino se pierden interacciones)
table_comb <- full_join(table1, table2, by = "station")
# convertir a 0 los NAs generados por el join
table_comb[[mag]] <- ifelse(is.na(table_comb[[mag]]), 0, table_comb[[mag]])
table_comb[[bgc]] <- ifelse(is.na(table_comb[[bgc]]), 0, table_comb[[bgc]])
# filt rows were both are 0
table_comb <- table_comb[!(table_comb[[mag]] == 0 & table_comb[[bgc]] == 0), ]
return(table_comb)
}
mags_by_sites <- prep_mags(meta_mags, mag_lineage)
# Count how many microbial lineages and BGC groups are per site
mags_by_sites <- prep_mags(meta_mags, mOTUs_Species_Cluster)
# Count how many microbial lineages and BGC groups are per site
mags_by_sites <- prep_mags(meta_mags,"mOTUs_Species_Cluster")
# Count how many microbial lineages and BGC groups are per site
mags_by_sites <- prep_mags(meta_mags,"mOTUs_Species_Clusters")
bgcs_by_sites<- prep_bgcs(meta_bgcs, "gcc")
# Args
option_list <- list(
make_option(c("-m", "--microbial_lineage"), type="character", default="mOTUs_Species_Cluster", help="Name of the microbial lienage"),
make_option(c("-b", "--bgc_groups"), type="character", default="gcc", help="Name of the grou"),
make_option(c("-s", "--minimum_sites"), type="numeric", default=10, help="Minimum number of sites where a group is present"),
make_option(c("-i", "--workdir"), type="character", help="Working directory"),
make_option(c("-o", "--outdir"), type="character", help="Output directory")
)
library(optparse)
# Args
option_list <- list(
make_option(c("-m", "--microbial_lineage"), type="character", default="mOTUs_Species_Cluster", help="Name of the microbial lienage"),
make_option(c("-b", "--bgc_groups"), type="character", default="gcc", help="Name of the grou"),
make_option(c("-s", "--minimum_sites"), type="numeric", default=10, help="Minimum number of sites where a group is present"),
make_option(c("-i", "--workdir"), type="character", help="Working directory"),
make_option(c("-o", "--outdir"), type="character", help="Output directory")
)
opt <- parse_args(OptionParser(option_list=option_list))
mag_lineage <- opt$microbial_lineage
bgc_group <- opt$bgc_groups
# Count how many microbial lineages and BGC groups are per site
mags_by_sites <- prep_mags(meta_mags, mag_lineage)
bgcs_by_sites<- prep_bgcs(meta_bgcs, bgc_group)
meta_bgcs <- read.csv("bgcs_metadata.csv")
bgcs_by_sites<- prep_bgcs(meta_bgcs, bgc_group)
View(ex)
example <- recreate_table("meta_mOTU_v25_12843", "gcc_92", mags_by_sites, bgcs_by_sites)
View(example)
#sitios con cordenadas
sites <- data.frame(
station = meta_mags$station,
latitude = meta_mags$latitude,
longitude = meta_mags$longitude
)
sites <- sites %>%
group_by(station) %>%
summarise(
longitude = first(longitude),
latitude = first(latitude)
)
#unir sitios a la tabla
example <- example %>%
left_join(sites %>% select(latitude, longitude, station), by = "station")
example <- example %>%
mutate(tipo = case_when(
meta_mOTU_v25_12843 > 0 & gcf_871 == 0 ~ "meta_mOTU",
meta_mOTU_v25_12843 == 0 & gcf_871 > 0 ~ "gcf",
meta_mOTU_v25_12843 > 0 & gcf_871 > 0  ~ "ambos",
TRUE                                   ~ "ninguno"
))
example <- example %>%
mutate(tipo = case_when(
meta_mOTU_v25_12843 > 0 & gcc_92 == 0 ~ "mOTU",
meta_mOTU_v25_12843 == 0 & gcc_92 > 0 ~ "GCC",
meta_mOTU_v25_12843 > 0 & gcc_92 > 0  ~ "Co-ocurrence",
TRUE                                   ~ "NA"
))
example <- example %>%
mutate(tipo = case_when(
meta_mOTU_v25_12843 > 0 & gcc_92 == 0 ~ "mOTU",
meta_mOTU_v25_12843 == 0 & gcc_92 > 0 ~ "GCC",
meta_mOTU_v25_12843 > 0 & gcc_92 > 0  ~ "Co-occurrence",
TRUE                                   ~ "NA"
))
cols <- c(
"mOTU" = "#009d14",
"GCC" = "#990099",
"Co-occurrence" = "darkblue",
"ninguno"   = "grey60"
)
# convertir a objeto espacial para terra
pts <- vect(example, geom = c("longitude", "latitude"), crs = "EPSG:4326")
mundo <- ne_countries(scale = "medium", returnclass = "sf")
oceanos <- ne_download(scale = "medium", type = "ocean", category = "physical", returnclass = "sf")
map <- ggplot() +
geom_sf(data = oceanos, fill = "#b4d3e2", color = NA) +
geom_sf(data = mundo, fill = "#5b6684", color = "#5b6684") +
geom_point(data = example, aes(x = longitude, y = latitude, color = tipo),
alpha = 0.9, size = 2) +
scale_color_manual(values = cols, name = "Tipo de interacción") +
theme_minimal() +
theme(legend.position = "bottom")
map
map <- ggplot() +
geom_sf(data = oceanos, fill = "#b4d3e2", color = NA) +
geom_sf(data = mundo, fill = "#5b6684", color = "#5b6684") +
geom_point(data = example, aes(x = longitude, y = latitude, color = tipo),
alpha = 0.9, size = 2) +
scale_color_manual(values = cols, name = "Type of interaction") +
theme_minimal() +
theme(legend.position = "bottom")
ggsave("map.png", plot = map, width = 42, height = 22, units = "cm")
View(meta_bgcs)
example <- recreate_table("meta_mOTU_v25_12843", "gcc_8", mags_by_sites, bgcs_by_sites)
#sitios con cordenadas
sites <- data.frame(
station = meta_mags$station,
latitude = meta_mags$latitude,
longitude = meta_mags$longitude
)
sites <- sites %>%
group_by(station) %>%
summarise(
longitude = first(longitude),
latitude = first(latitude)
)
#unir sitios a la tabla
example <- example %>%
left_join(sites %>% select(latitude, longitude, station), by = "station")
example <- example %>%
mutate(tipo = case_when(
meta_mOTU_v25_12843 > 0 & gcc_8 == 0 ~ "mOTU",
meta_mOTU_v25_12843 == 0 & gcc_8 > 0 ~ "GCC",
meta_mOTU_v25_12843 > 0 & gcc_8 > 0  ~ "Co-occurrence",
TRUE                                   ~ "NA"
))
cols <- c(
"mOTU" = "#009d14",
"GCC" = "#990099",
"Co-occurrence" = "darkblue",
"ninguno"   = "grey60"
)
View(example)
map <- ggplot() +
geom_sf(data = oceanos, fill = "#b4d3e2", color = NA) +
geom_sf(data = mundo, fill = "#5b6684", color = "#5b6684") +
geom_point(data = example, aes(x = longitude, y = latitude, color = tipo),
alpha = 0.9, size = 2) +
scale_color_manual(values = cols, name = "Type of interaction") +
theme_minimal()
map
map <- ggplot() +
geom_sf(data = oceanos, fill = "#b4d3e2", color = NA) +
geom_sf(data = mundo, fill = "#5b6684", color = "#5b6684") +
geom_point(data = example, aes(x = longitude, y = latitude, color = tipo),
alpha = 0.9, size = 2) +
scale_color_manual(values = cols, name = "Type of interaction") +
theme_minimal() +
theme(plot.background = element_rect(fill = NA, color = NA),
panel.background = element_rect(fill = NA, color = NA))
ggsave("map.png", plot = map, width = 42, height = 22, units = "cm", bg = "transparent")
map <- ggplot() +
geom_sf(data = oceanos, fill = "#b4d3e2", color = NA) +
geom_sf(data = mundo, fill = "#5b6684", color = "#5b6684") +
geom_point(data = example, aes(x = longitude, y = latitude, color = tipo),
alpha = 0.9, size = 2) +
scale_color_manual(values = cols, name = "Type of interaction") +
theme_minimal(base_size = 18) +
theme( plot.background = element_rect(fill = NA, color = NA),   # fondo transparente
panel.background = element_rect(fill = NA, color = NA),  # panel transparente
legend.background = element_rect(fill = NA, color = NA), # fondo de leyenda transparente
legend.key = element_rect(fill = NA, color = NA),        # clave de leyenda transparente
axis.text = element_text(size = 16),
axis.title = element_text(size = 18, face = "bold"),
legend.title = element_text(size = 18, face = "bold"),
legend.text = element_text(size = 16))
ggsave("map.png", plot = map, width = 42, height = 22, units = "cm", bg = "transparent")
View(meta_mags)
#gcf_871 <- meta_bgcs %>%
#  filter(gcf == "gcf_871")
mOTU12843 <- meta_mags %>%
filter(mOTUs_Species_Cluster == "meta_mOTU_v25_12843")
View(meta_mags)
View(mOTU12843)
gcc_8 <- meta_bgcs %>%
filter(gcf == "gcc_8")
View(gcc_8)
gcc_8 <- meta_bgcs %>%
filter(gcc == "gcc_8")
View(gcc_8)
View(gcc_8)
View(mOTU12843)
View(ex)
mOTU12843 <- meta_mags %>%
filter(mOTUs_Species_Cluster == "meta_mOTU_v25_123")
mOTU12843 <- meta_mags %>%
filter(mOTUs_Species_Cluster == "meta_mOTU_v25_12843")
View(ex)
gcc_8 <- meta_bgcs %>%
filter(gcc == "gcc_123")
View(gcc_8)
View(example)
View(ex)
View(example)
View(mOTU12843)
